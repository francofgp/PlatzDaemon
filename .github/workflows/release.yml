name: ğŸ¾ Publicar Release

# Se dispara cuando pusheas un tag con formato v*.*.*
on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Instalar .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: ğŸ“¦ Publicar EXE (self-contained, single-file)
        run: dotnet publish -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -o ./publish

      - name: ğŸ—œï¸ Empaquetar en ZIP
        run: Compress-Archive -Path ./publish/* -DestinationPath ./PlatzDaemon-${{ github.ref_name }}-win-x64.zip

      - name: ğŸ“ Extraer notas del CHANGELOG
        id: changelog
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}" -replace '^v', ''
          $content = Get-Content CHANGELOG.md -Raw
          # Extraer la secciÃ³n de la versiÃ³n actual (entre ## [version] y el siguiente ## [)
          if ($content -match "(?s)## \[$version\][^\r\n]*\r?\n(.*?)(?=\r?\n## \[|$)") {
            $notes = $Matches[1].Trim()
          } else {
            $notes = "Release ${{ github.ref_name }}"
          }
          # Guardar en archivo para evitar problemas con caracteres especiales
          $notes | Out-File -FilePath release-notes.md -Encoding utf8

      - name: ğŸš€ Crear Release en GitHub
        uses: softprops/action-gh-release@v2
        with:
          name: "ğŸ¾ PlatzDaemon ${{ github.ref_name }}"
          body_path: release-notes.md
          files: ./PlatzDaemon-${{ github.ref_name }}-win-x64.zip
          draft: false
          prerelease: false
