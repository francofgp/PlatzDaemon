@page
@model PlatzDaemon.Pages.IndexModel
@{
    ViewData["Title"] = "Dashboard";
}

<pre class="ascii-art">
 ____  _       _         ____                                  
|  _ \| | __ _| |_ ___  |  _ \  __ _  ___ _ __ ___   ___  _ __  
| |_) | |/ _` | __|_  / | | | |/ _` |/ _ \ '_ ` _ \ / _ \| '_ \ 
|  __/| | (_| | |_ / /  | |_| | (_| |  __/ | | | | | (_) | | | |
|_|   |_|\__,_|\__/___| |____/ \__,_|\___|_| |_| |_|\___/|_| |_|
</pre>

<div class="status-panel">
    <div class="status-row">
        <div class="status-item">
            <div class="status-label">Estado</div>
            <div class="status-value" id="statusText">
                <span class="status-@Model.StatusCss">@Model.StatusText</span>
            </div>
        </div>
        <div class="status-item">
            <div class="status-label">Proximo disparo</div>
            <div class="countdown @(Model.IsCountdownDisabled ? "disabled" : "")" id="countdown">@Model.NextRunDisplay</div>
        </div>
        <div class="status-item">
            <div class="status-label">Ultimo resultado</div>
            <div class="status-value" id="lastResult">@(Model.LastResult ?? "---")</div>
        </div>
        <div class="status-item">
            <div class="status-label">WhatsApp</div>
            <div class="status-value">
                @if (Model.WhatsAppConnected)
                {
                    <span class="session-dot connected"></span> @:Conectado
                }
                else if (Model.HasSavedSession)
                {
                    <span class="session-dot saved"></span> @:Sesion guardada
                }
                else
                {
                    <span class="session-dot disconnected"></span> @:Desconectado
                }
            </div>
        </div>
    </div>
</div>

<div class="dashboard-actions mb-2">
    <div class="actions-col">
        <form method="post" asp-page-handler="ManualRun">
            <button type="submit" class="btn btn-primary">[ Ejecutar ahora ]</button>
        </form>
        <form method="post" asp-page-handler="ClearLogs">
            <button type="submit" class="btn btn-error">[ Limpiar logs ]</button>
        </form>
    </div>
    <div class="config-summary">
        <div class="summary-line"><span class="summary-icon">🎾</span> @Model.GameType · @Model.PreferredPeriod · @Model.BookingDay</div>
        <div class="summary-line"><span class="summary-icon">⏰</span> @Model.TimeSlots</div>
        <div class="summary-line"><span class="summary-icon">🏟</span> @Model.Courts</div>
        <a href="/Config" class="summary-edit">[ editar → ]</a>
    </div>
</div>

<h3>Terminal de logs</h3>
<div class="log-console" id="logConsole">
    @foreach (var log in Model.Logs)
    {
        <div class="log-entry @log.CssClass">
            <span class="log-time">[@log.FormattedTime]</span>
            <span class="log-prefix">@log.Prefix</span>
            <span>@log.Message</span>
        </div>
    }
</div>

@section Scripts {
<script>
    // SignalR connection for real-time logs
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/loghub")
        .withAutomaticReconnect()
        .build();

    const logConsole = document.getElementById('logConsole');

    connection.on("ReceiveLog", (time, prefix, message, cssClass) => {
        const entry = document.createElement('div');
        entry.className = 'log-entry ' + cssClass;
        entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-prefix">${prefix}</span> <span>${escapeHtml(message)}</span>`;
        logConsole.appendChild(entry);
        logConsole.scrollTop = logConsole.scrollHeight;
    });

    connection.on("StatusUpdate", (status, result, nextRunIso) => {
        const statusEl = document.getElementById('statusText');
        const resultEl = document.getElementById('lastResult');
        const countdownEl = document.getElementById('countdown');
        const css = status.toLowerCase();
        statusEl.innerHTML = `<span class="status-${css}">${status}</span>`;
        if (result) resultEl.textContent = result;

        // Update countdown based on new nextRun value
        if (nextRunIso && nextRunIso !== '') {
            currentNextRun = new Date(nextRunIso);
            countdownEl.classList.remove('disabled');
        } else {
            currentNextRun = null;
            countdownEl.textContent = 'Desactivado';
            countdownEl.classList.add('disabled');
        }
    });

    connection.start().catch(err => console.error('SignalR Error:', err));

    // Countdown timer (reactive to SignalR updates)
    let currentNextRun = null;
    const initialNextRunStr = '@Model.NextRunIso';
    if (initialNextRunStr && initialNextRunStr !== '') {
        currentNextRun = new Date(initialNextRunStr);
    }

    function updateCountdown() {
        const countdownEl = document.getElementById('countdown');
        if (!currentNextRun) {
            countdownEl.textContent = 'Desactivado';
            countdownEl.classList.add('disabled');
            return;
        }
        countdownEl.classList.remove('disabled');
        const now = new Date();
        const diff = currentNextRun - now;
        if (diff <= 0) {
            countdownEl.textContent = '00:00:00';
            return;
        }
        const h = Math.floor(diff / 3600000).toString().padStart(2, '0');
        const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
        const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
        countdownEl.textContent = `${h}:${m}:${s}`;
    }
    setInterval(updateCountdown, 1000);
    updateCountdown();

    // Auto-scroll log console
    logConsole.scrollTop = logConsole.scrollHeight;

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
}
